<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý mượn sách - Thư viện</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .action-btn {
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
        }
        .return-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
        }
        .edit-btn {
            background-color: #2196F3;
            color: white;
            border: none;
        }
        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
        }
        .search-container {
            margin-bottom: 20px;
        }
        #searchInput {
            padding: 8px;
            width: 300px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .item-list {
            margin-top: 10px;
        }
        .item {
            border-bottom: 1px solid #eee;
            padding: 5px 0;
        }
    </style>
</head>
<body>
    <h1>Quản lý mượn sách</h1>
    
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Tìm kiếm theo tên người mượn...">
        <button onclick="searchBorrowRecords()">Tìm kiếm</button>
        <select id="statusFilter" onchange="filterByStatus()">
            <option value="all">Tất cả</option>
            <option value="active">Đang mượn</option>
            <option value="returned">Đã trả</option>
        </select>
    </div>
    
    <table id="borrowTable">
        <thead>
            <tr>
                <th>Mã mượn</th>
                <th>Người mượn</th>
                <th>Ngày mượn</th>
                <th>Số lượng sách</th>
                <th>Trạng thái</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody id="borrowList">
            <!-- Dữ liệu mượn sách sẽ được thêm vào đây -->
        </tbody>
    </table>
    
    <!-- Modal chi tiết -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Chi tiết mượn sách</h2>
            <div id="modalContent"></div>
        </div>
    </div>
    
    <script>
        // Khởi tạo Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Lấy danh sách mượn sách
        function fetchBorrowRecords(searchTerm = '', status = 'all') {
            let query = db.collection('borrowRecords').orderBy('borrowDate', 'desc');
            
            if (searchTerm) {
                query = query.where('borrowerName', '>=', searchTerm)
                             .where('borrowerName', '<=', searchTerm + '\uf8ff');
            }
            
            if (status !== 'all') {
                query = query.where('status', '==', status);
            }
            
            query.onSnapshot((snapshot) => {
                const borrowList = document.getElementById('borrowList');
                borrowList.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const record = doc.data();
                    const row = document.createElement('tr');
                    row.dataset.id = doc.id;
                    
                    // Tính tổng số lượng sách mượn
                    const totalItems = record.items.reduce((sum, item) => sum + item.quantity, 0);
                    
                    // Định dạng ngày
                    const borrowDate = record.borrowDate.toDate();
                    const formattedDate = borrowDate.toLocaleDateString('vi-VN');
                    
                    row.innerHTML = `
                        <td>${record.borrowId}</td>
                        <td>${record.borrowerName}</td>
                        <td>${formattedDate}</td>
                        <td>${totalItems}</td>
                        <td>${record.status === 'active' ? 'Đang mượn' : 'Đã trả'}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="showDetails('${doc.id}')">Chi tiết</button>
                            ${record.status === 'active' ? 
                                `<button class="action-btn return-btn" onclick="returnBooks('${doc.id}')">Trả sách</button>` : 
                                ''}
                            <button class="action-btn delete-btn" onclick="deleteRecord('${doc.id}')">Xóa</button>
                        </td>
                    `;
                    
                    borrowList.appendChild(row);
                });
            });
        }
        
        // Tìm kiếm hồ sơ mượn
        function searchBorrowRecords() {
            const searchTerm = document.getElementById('searchInput').value;
            const status = document.getElementById('statusFilter').value;
            fetchBorrowRecords(searchTerm, status);
        }
        
        // Lọc theo trạng thái
        function filterByStatus() {
            const status = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchInput').value;
            fetchBorrowRecords(searchTerm, status);
        }
        
        // Hiển thị chi tiết hồ sơ mượn
        async function showDetails(recordId) {
            const modal = document.getElementById('detailModal');
            const modalContent = document.getElementById('modalContent');
            
            try {
                const doc = await db.collection('borrowRecords').doc(recordId).get();
                if (doc.exists) {
                    const record = doc.data();
                    
                    let html = `
                        <p><strong>Người mượn:</strong> ${record.borrowerName}</p>
                        <p><strong>Ngày mượn:</strong> ${record.borrowDate.toDate().toLocaleDateString('vi-VN')}</p>
                        <p><strong>Trạng thái:</strong> ${record.status === 'active' ? 'Đang mượn' : 'Đã trả'}</p>
                        
                        <h3>Danh sách sách mượn:</h3>
                        <div class="item-list">
                    `;
                    
                    record.items.forEach(item => {
                        html += `
                            <div class="item">
                                <p><strong>Tên sách:</strong> ${item.bookName}</p>
                                <p><strong>Mã sách:</strong> ${item.bookId}</p>
                                <p><strong>Số lượng:</strong> ${item.quantity}</p>
                                <p><strong>Ngày bắt đầu:</strong> ${item.startDate}</p>
                                <p><strong>Thời gian mượn:</strong> ${item.duration} ngày</p>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                    
                    modalContent.innerHTML = html;
                    modal.style.display = 'block';
                }
            } catch (error) {
                console.error('Lỗi khi lấy chi tiết hồ sơ:', error);
                alert('Có lỗi xảy ra khi lấy thông tin chi tiết');
            }
        }
        
        // Đóng modal
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        
        // Trả sách
        async function returnBooks(recordId) {
            if (!confirm('Xác nhận trả tất cả sách trong hồ sơ này?')) return;
            
            try {
                // Lấy thông tin hồ sơ mượn
                const recordDoc = await db.collection('borrowRecords').doc(recordId).get();
                const recordData = recordDoc.data();
                
                // Tạo batch để cập nhật nhiều document
                const batch = db.batch();
                
                // Cập nhật số lượng sách trong từng cuốn sách
                for (const item of recordData.items) {
                    const bookRef = db.collection('books').doc(item.bookId);
                    batch.update(bookRef, {
                        borrowedQuantity: firebase.firestore.FieldValue.increment(-item.quantity),
                        availableQuantity: firebase.firestore.FieldValue.increment(item.quantity)
                    });
                }
                
                // Cập nhật trạng thái hồ sơ mượn
                const recordRef = db.collection('borrowRecords').doc(recordId);
                batch.update(recordRef, {
                    status: 'returned',
                    returnDate: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Thực hiện batch write
                await batch.commit();
                
                alert('Đã cập nhật trạng thái trả sách thành công!');
                
            } catch (error) {
                console.error('Lỗi khi trả sách:', error);
                alert('Có lỗi xảy ra khi trả sách. Vui lòng thử lại.');
            }
        }
        
        // Xóa hồ sơ mượn
        async function deleteRecord(recordId) {
            if (!confirm('Bạn có chắc chắn muốn xóa hồ sơ mượn này?')) return;
            
            try {
                await db.collection('borrowRecords').doc(recordId).delete();
                alert('Đã xóa hồ sơ mượn thành công!');
            } catch (error) {
                console.error('Lỗi khi xóa hồ sơ:', error);
                alert('Có lỗi xảy ra khi xóa hồ sơ. Vui lòng thử lại.');
            }
        }
        
        // Tải danh sách khi trang được tải
        window.onload = fetchBorrowRecords;
        
        // Đóng modal khi click ra ngoài
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
